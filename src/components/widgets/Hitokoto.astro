---
// Hitokoto.astro
// 获取"一言" (Hitokoto) 并显示，带打字机效果
---

<div
  id="hitokoto-container"
  class="min-h-[1.5em] flex items-center justify-center text-2xl md:text-3xl"
  style="font-family: 'ZCOOL KuaiLe', cursive;"
>
  <span id="hitokoto_text" class="select-none font-medium"></span>
</div>

<script>
  const FALLBACK_QUOTES = [{ hitokoto: "It wraps me in the sparkling twilight.", from: "Original", from_who: "HaMan" }];

  function fetchHitokoto() {
    const textElement = document.getElementById("hitokoto_text");
    if (!textElement) return;

    // 清空文本，准备打字
    textElement.innerHTML = "";

    const typeText = (text: string, from: string) => {
      let i = 0;
      const speed = 100; // 打字速度 ms

      // 设置 title (鼠标悬停显示出处)
      textElement.title = from;

      const type = () => {
        if (i < text.length) {
          // 每次打字都更新文本 + 光标
          textElement.innerHTML = text.substring(0, i + 1) + '<span class="cursor">|</span>';
          i++;
          setTimeout(type, speed);
        } else {
          // 打字完成，保留光标在文字末尾
          textElement.innerHTML = text + '<span class="cursor">|</span>';
        }
      };
      // 立即开始打字
      type();
    };

    const updateText = (data: any) => {
      const fullText = data.hitokoto;
      const source = `—— ${data.from_who || "佚名"}「${data.from || "未知"}」`;
      typeText(fullText, source);
    };

    // 使用自部署的 HTTPS 一言 API
    const timestamp = new Date().getTime();
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒超时

    const apiUrl = `https://hitokoto.furprint.top/?t=${timestamp}`;

    fetch(apiUrl, {
      signal: controller.signal,
    })
      .then((response) => {
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error("Network response was not ok");
        return response.json();
      })
      .then((data) => {
        console.log("✅ 一言 API 成功:", data.hitokoto);
        updateText(data);
      })
      .catch((err) => {
        clearTimeout(timeoutId);
        if (err.name === "AbortError") {
          console.warn("⏱️ API 超时（3秒），使用预设");
        } else {
          console.warn("⚠️ API 失败，使用预设:", err.message);
        }
        // API 失败或超时，显示预设
        const randomQuote = FALLBACK_QUOTES[Math.floor(Math.random() * FALLBACK_QUOTES.length)];
        updateText(randomQuote);
      });
  }

  // 仅在页面加载时获取一言
  document.addEventListener("astro:page-load", fetchHitokoto);
</script>

<style is:global>
  #hitokoto_text {
    display: inline;
    max-width: 80vw;
    white-space: pre-wrap;
    word-break: break-word;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  /* 光标样式 - 必须使用 is:global 因为光标是动态插入的 */
  #hitokoto_text .cursor {
    display: inline;
    font-weight: bold;
    color: white;
    animation: blink 1s step-end infinite;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    margin-left: 2px;
  }

  @keyframes blink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }
</style>
