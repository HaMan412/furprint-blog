---
import { SITE_TITLE, SITE_MENU, t } from "../config";
import { Icon } from "astro-icon/components";
import ThemeToggle from "./widgets/ThemeToggle.astro";

const currentPath = Astro.url.pathname;

// Type safely process SITE_MENU before rendering
type SubMenuItem = {
  id: string;
  text: string;
  href: string;
  svg: string;
  target?: string;
};

type MenuItem = {
  id: string;
  text: string;
  href: string;
  svg: string;
  target?: string;
  subItems?: SubMenuItem[];
};

const typedMenu = SITE_MENU as MenuItem[];
---

<!-- Desktop Nav -->
<div id="top-nav" class="hidden md:flex items-center px-8 py-1 transition-all duration-300 w-full relative">
  <!-- Site Title (Left) -->
  <div class="flex flex-col items-start gap-1">
    <a href="/" class="text-xl font-black tracking-wider text-white hover:opacity-80 transition-opacity drop-shadow-md">
      {SITE_TITLE}
    </a>
    <!-- Real-time Clock -->
    <div
      class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 backdrop-blur-sm border border-white/10 text-sm font-medium text-white/90 tracking-wider shadow-sm mt-1"
    >
      <Icon name="lucide:clock" class="w-4 h-4 opacity-80" />
      <span id="clock-text" class="font-mono pt-[1px]">00:00:00</span>
    </div>
  </div>

  <!-- Menu items with glassmorphism background (Centered) -->
  <div
    id="nav-menu"
    class="absolute left-1/2 -translate-x-1/2 flex items-center gap-1 md:px-2 lg:px-4 py-2 rounded-full backdrop-blur-md bg-base-100/70 shadow-lg transition-all duration-300 whitespace-nowrap md:scale-75 lg:scale-90 xl:scale-100 origin-center"
  >
    {
      typedMenu.map((item) => (
        <div class="relative group">
          {item.subItems ? (
            <div class="dropdown dropdown-hover dropdown-end">
              <div
                tabindex="0"
                role="button"
                class={`flex items-center gap-2 md:px-2 lg:px-4 py-2 rounded-full transition-all duration-300 cursor-pointer text-base-content/90 hover:bg-base-200/50 hover:text-base-content font-medium
                  ${currentPath.startsWith(item.href) ? "bg-base-200/60 font-bold" : ""}`}
              >
                <Icon name={item.svg} class="w-5 h-5" />
                <span class="tracking-wide">{item.text}</span>
                <Icon
                  name="lucide:chevron-down"
                  class="w-3.5 h-3.5 opacity-70 group-hover:rotate-180 transition-transform duration-300"
                />
              </div>
              <ul
                tabindex="0"
                class="dropdown-content z-[1] menu p-2 shadow-[0_8px_30px_rgb(0,0,0,0.12)] bg-base-100/80 backdrop-blur-xl rounded-2xl w-56 mt-4 border border-base-300/20"
              >
                {item.subItems.map((subItem) => (
                  <li>
                    <a
                      href={subItem.href}
                      target={subItem.target || "_self"}
                      class={`flex items-center gap-3 py-3 px-4 rounded-xl transition-all duration-200 text-base-content/80 hover:bg-base-200/50 hover:text-primary hover:pl-6 font-medium
                        ${currentPath === subItem.href ? "bg-primary/10 text-primary font-bold" : ""}`}
                    >
                      <Icon name={subItem.svg} class="w-4 h-4" />
                      {subItem.text}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            <a
              href={item.href}
              target={item.target || "_self"}
              class={`flex items-center gap-2 md:px-2 lg:px-4 py-2 rounded-full transition-all duration-300 text-base-content/90 hover:bg-base-200/50 hover:text-base-content font-medium
                ${currentPath === item.href ? "bg-base-200/60 font-bold" : ""}`}
            >
              <Icon name={item.svg} class="w-5 h-5" />
              <span class="tracking-wide">{item.text}</span>
            </a>
          )}
        </div>
      ))
    }

    <form action="/blog/search" method="get" class="relative group" data-astro-reload>
      <div class="relative flex items-center">
        <input
          type="text"
          name="q"
          placeholder={t("label.search") || "Search..."}
          class="input input-sm rounded-full bg-base-200/50 border border-base-300/30 text-base-content placeholder-base-content/60 focus:bg-base-200/70 focus:border-base-300/50 md:w-24 lg:w-40 focus:w-56 transition-all duration-300 pl-9 pr-4 text-sm"
          aria-label={t("label.search") || "Search"}
        />
        <div class="absolute left-3 text-base-content/60 group-focus-within:text-base-content transition-colors">
          <Icon name="lucide:search" class="w-4 h-4" />
        </div>
      </div>
    </form>

    <ThemeToggle />
  </div>
</div>

<!-- Mobile Nav -->
<div id="mobile-nav" class="flex md:hidden justify-between items-center w-full relative z-50">
  <button id="mobile-menu-toggle" class="btn btn-circle btn-ghost text-white" aria-label="Menu">
    <Icon name="lucide:menu" class="w-6 h-6" id="menu-icon-open" />
    <Icon name="lucide:x" class="w-6 h-6 hidden" id="menu-icon-close" />
  </button>

  <a href="/" class="text-xl font-black tracking-wider text-white drop-shadow-md">
    {SITE_TITLE}
  </a>

  <ThemeToggle />
</div>

<!-- Mobile Menu Dropdown -->
<div
  id="mobile-menu-dropdown"
  class="absolute top-full left-0 right-0 mt-2 mx-4 bg-base-100/95 backdrop-blur-xl rounded-2xl shadow-2xl transform origin-top-left scale-0 opacity-0 transition-all duration-300 md:hidden z-40 overflow-hidden"
>
  <div class="py-2 px-2">
    <ul class="menu menu-lg w-full text-base-content">
      {
        typedMenu.map((item) => (
          <li>
            {item.subItems ? (
              <details>
                <summary class="font-medium rounded-xl">
                  <Icon name={item.svg} class="w-5 h-5" />
                  {item.text}
                </summary>
                <ul>
                  {item.subItems.map((subItem) => (
                    <li>
                      <a href={subItem.href} class={`rounded-xl ${currentPath === subItem.href ? "active" : ""}`}>
                        <Icon name={subItem.svg} class="w-4 h-4" />
                        {subItem.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            ) : (
              <a href={item.href} class={`font-medium rounded-xl ${currentPath === item.href ? "active" : ""}`}>
                <Icon name={item.svg} class="w-5 h-5" />
                {item.text}
              </a>
            )}
          </li>
        ))
      }
    </ul>
  </div>
</div>

<script>
  document.addEventListener("keydown", (e) => {
    const target = e.target as HTMLElement;
    if (e.key === "/" && target && target.tagName !== "INPUT" && target.tagName !== "TEXTAREA") {
      e.preventDefault();
      const searchInput = document.querySelector('input[name="q"]');
      if (searchInput) {
        (searchInput as HTMLInputElement).focus();
      }
    }
  });

  // Real-time Clock
  function updateClock() {
    const clockText = document.getElementById("clock-text");
    if (clockText) {
      const now = new Date();
      const timeString = now.toLocaleTimeString("en-US", {
        hour12: false,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
      clockText.textContent = timeString;
    }
  }

  // Start clock
  updateClock();
  setInterval(updateClock, 1000);

  // Mobile Menu Logic
  function initMobileMenu() {
    const toggleBtn = document.getElementById("mobile-menu-toggle");
    const dropdown = document.getElementById("mobile-menu-dropdown");
    const iconOpen = document.getElementById("menu-icon-open");
    const iconClose = document.getElementById("menu-icon-close");

    if (toggleBtn && dropdown && iconOpen && iconClose) {
      const toggleMenu = () => {
        const isClosed = dropdown.classList.contains("scale-0");

        if (isClosed) {
          // Open menu
          dropdown.classList.remove("scale-0", "opacity-0");
          dropdown.classList.add("scale-100", "opacity-100");
          iconOpen.classList.add("hidden");
          iconClose.classList.remove("hidden");
        } else {
          // Close menu
          dropdown.classList.add("scale-0", "opacity-0");
          dropdown.classList.remove("scale-100", "opacity-100");
          iconOpen.classList.remove("hidden");
          iconClose.classList.add("hidden");
        }
      };

      toggleBtn.onclick = toggleMenu;

      // Close when clicking outside
      document.addEventListener("click", (e) => {
        if (!toggleBtn.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {
          dropdown.classList.add("scale-0", "opacity-0");
          dropdown.classList.remove("scale-100", "opacity-100");
          iconOpen.classList.remove("hidden");
          iconClose.classList.add("hidden");
        }
      });
    }
  }

  // Re-run on page navigation
  document.addEventListener("astro:page-load", () => {
    updateClock();
    initMobileMenu();
  });

  // Init on first load
  initMobileMenu();
</script>
