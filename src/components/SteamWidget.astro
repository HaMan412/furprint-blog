---
const { apiEndpoint } = Astro.props;
---

<div id="steam-widget-container" class="text-sm" data-api-endpoint={apiEndpoint}>
  <!-- ▼▼▼ 核心修改：将 space-y-4 修改为 space-y-2 ▼▼▼ -->
  <div id="steam-widget-content" class="space-y-2">
    <p>正在加载 Steam 信息...</p>
  </div>
</div>

<script is:inline>
  function steamWidgetScript() {
    const widgetContainer = document.querySelector('#steam-widget-container');
    if (!widgetContainer) return;

    function updateSteamWidget(data) {
      const steamContainer = widgetContainer.querySelector('#steam-widget-content');
      if (!steamContainer) return;

      if (data && data.recentlyPlayed && data.recentlyPlayed.length > 0) {
        
        const gamesHtml = data.recentlyPlayed.map(game => {
          const playtimeHours = (game.playtime_2weeks / 60).toFixed(1);
          return `
            <div class="flex items-center gap-3 overflow-hidden">
              <img src="${game.icon_url}" alt="${game.name} icon" class="flex-shrink-0 w-8 h-8 rounded-md shadow object-cover">
              <div class="overflow-hidden">
                <p class="font-semibold text-base-content truncate" title="${game.name}">${game.name}</p>
                <p class="text-xs text-base-content/70 truncate">近两周: ${playtimeHours} 小时</p>
              </div>
            </div>
          `;
        }).join('');

        steamContainer.innerHTML = gamesHtml;
      } else {
        steamContainer.innerHTML = '<p>当前没有在玩游戏</p>';
      }
    }

    async function fetchSteamData() {
      const apiEndpoint = widgetContainer.dataset.apiEndpoint;
      if (!apiEndpoint) return;
      try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        updateSteamWidget(data);
      } catch (error) {
        console.error("Failed to fetch Steam data:", error);
        const steamContainer = widgetContainer.querySelector('#steam-widget-content');
        if(steamContainer) steamContainer.innerHTML = '<p class="text-error">获取 Steam 信息失败</p>';
      }
    }
    
    document.addEventListener('astro:page-load', fetchSteamData);
    document.addEventListener('refresh-widgets', fetchSteamData);
a  }
  steamWidgetScript();
</script>
