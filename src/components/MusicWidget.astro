---
import { MUSIC_ICON_URL } from '@config';
---

<div 
  id="music-widget-container" 
  class="music-widget-transparent" 
  data-icon-url={MUSIC_ICON_URL}
>
  <h4 class="text-sm font-bold mb-3 text-base-content/80">哈曼正在听的歌</h4>
  <div id="music-widget-content">
    <div class="placeholder-item">
      <div class="animated-background"></div>
    </div>
  </div>
</div>

<script>
  interface SongData {
    playing: boolean;
    song: string | null;
  }

  const API_ENDPOINT = "http://45.207.193.240:1633/now-playing";
  
  // 将关键的 DOM 元素选择器放在外面，方便复用
  const container = document.getElementById('music-widget-container');
  const contentDiv = document.getElementById('music-widget-content');
  const musicIconUrl = container?.dataset.iconUrl;
  
  // 在脚本加载时，立即保存初始的加载动画HTML
  const placeholderHtml = contentDiv ? contentDiv.innerHTML : '';

  // 封装一个独立的函数，用于显示加载状态
  function showLoadingState() {
    if (contentDiv) {
      contentDiv.innerHTML = placeholderHtml;
    }
  }

  // 更新UI的函数，保持不变
  function updateMusicWidget(data: SongData) {
    if (!contentDiv) return;

    let html = '';
    if (data && data.playing && data.song) {
      const parts = data.song.split(' - ');
      const songName = parts[0];
      const artist = parts.length > 1 ? parts.slice(1).join(' - ') : '未知艺术家';

      const iconHtml = musicIconUrl
        ? `<img src="${musicIconUrl}" alt="Music Icon" class="custom-music-icon">`
        : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>`;

      html = `
        <div class="song-item">
          <div class="music-icon">
            ${iconHtml}
          </div>
          <div class="song-info">
            <strong>${songName || '未知歌曲'}</strong>
            <span>${artist}</span>
          </div>
        </div>
      `;
    } else {
      html = `
        <div class="no-song">
          <p>当前没有在听歌</p>
        </div>
      `;
    }
    contentDiv.innerHTML = html;
  }

  // 获取数据的核心函数
  async function fetchMusicData() {
    // 【核心修改 1】每次获取数据前，先调用函数显示加载动画
    showLoadingState();
    try {
      const response = await fetch(API_ENDPOINT);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      const data: SongData = await response.json();
      updateMusicWidget(data);
    } catch (error) {
      console.error("无法获取音乐数据:", error);
      updateMusicWidget({ playing: false, song: null });
    }
  }

  // 【核心修改 2】重构页面加载和事件监听的逻辑
  document.addEventListener('astro:page-load', () => {
    // 1. 页面首次加载时，获取一次数据
    fetchMusicData();
    
    // 2. 监听来自 BaseLayout 的全局刷新信号
    document.addEventListener('refresh-widgets', fetchMusicData);
  });
</script>

<style>
  /* 样式部分与您提供的完全一致，无需改动 */
  .music-widget-transparent {
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 1px solid oklch(var(--b2));
  }
  :global(.song-item) {
    display: flex !important;
    align-items: center !important;
    gap: 12px;
  }
  :global(.music-icon) {
    width: 32px !important;
    height: 32px !important;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: oklch(var(--b2));
    border-radius: 6px;
    flex-shrink: 0;
    overflow: hidden;
  }
  :global(.music-icon svg) {
    width: 18px;
    height: 18px;
    color: oklch(var(--bc) / 0.8);
  }
  :global(.music-icon .custom-music-icon) {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }
  :global(.song-info) {
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }
  :global(.song-info strong) {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--fallback-bc, oklch(var(--bc) / 1));
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  :global(.song-info span) {
    font-size: 0.8em;
    color: var(--fallback-bc, oklch(var(--bc) / 0.6));
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  :global(.no-song p) {
    font-size: 0.85em;
    color: var(--fallback-bc, oklch(var(--bc) / 0.7));
  }
  .placeholder-item {
    height: 32px;
    width: 100%;
    background-color: oklch(var(--b2));
    border-radius: 6px;
    overflow: hidden;
  }
  .animated-background {
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      oklch(var(--b3)),
      transparent
    );
    background-size: 200% 100%;
    animation: loadingAnimation 1.5s infinite linear;
  }
  @keyframes loadingAnimation {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>
