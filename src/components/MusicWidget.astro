---
const { apiEndpoint } = Astro.props;
---

<div id="music-widget-container" class="text-sm mt-2" data-api-endpoint={apiEndpoint}>
  <div id="music-widget-content">
    <p>正在加载音乐信息...</p>
  </div>
</div>

<script is:inline>
  function musicWidgetScript() {
    const widgetContainer = document.querySelector('#music-widget-container');
    if (!widgetContainer) return;

    function updateMusicWidget(data) {
      const musicContainer = widgetContainer.querySelector('#music-widget-content');
      if (!musicContainer) return;

      if (data && data.playing && typeof data.song === 'string' && data.song.trim() !== '') {
        const parts = data.song.split(' - ');
        const name = parts[0] || '未知歌曲';
        const artist = parts.slice(1).join(' - ') || '未知艺术家';
        
        const CUSTOM_ICON_URL = "https://vip.123pan.cn/1815727707/yk6baz03t0l000d7w33fsavgcc6j1mkoDIYPAIUvAwUOAvxvAdrxAa==.png"; // 别忘了这里是您的链接

        musicContainer.innerHTML = `
          <div class="flex items-center gap-3 overflow-hidden">
            <!-- ▼▼▼ 核心修改：将 w-8 h-8 修改为 w-10 h-10 ▼▼▼ -->
            <img src="${CUSTOM_ICON_URL}" alt="Music Icon" class="flex-shrink-0 w-10 h-10 rounded-md shadow object-cover">
            <div class="overflow-hidden">
              <p class="font-semibold text-sm text-base-content truncate" title="${name}">${name}</p>
              <p class="text-sm text-base-content/70 truncate" title="${artist}">${artist}</p>
            </div>
          </div>
        `;
      } else {
        musicContainer.innerHTML = '<p>当前没有在听歌</p>';
      }
    }

    async function fetchMusicData() {
      const apiEndpoint = widgetContainer.dataset.apiEndpoint;
      if (!apiEndpoint) return;
      try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        updateMusicWidget(data);
      } catch (error) {
        console.error("Failed to fetch music data:", error);
        const musicContainer = widgetContainer.querySelector('#music-widget-content');
        if (musicContainer) musicContainer.innerHTML = '<p class="text-error">获取音乐信息失败</p>';
      }
    }
    
    document.addEventListener('astro:page-load', fetchMusicData);
    document.addEventListener('refresh-widgets', fetchMusicData);
  }
  musicWidgetScript();
</script>
