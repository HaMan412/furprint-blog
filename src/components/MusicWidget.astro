---
// 无需修改
const API_ENDPOINT = "https://music.furprint.cn";
---

<div id="music-widget-container" class="text-sm mt-4">
  <h2 class="text-lg font-bold mb-2">哈曼正在听的歌</h2>
  <div id="music-widget-content">
    <p>正在加载音乐信息...</p>
  </div>
</div>

<script define:vars={{ API_ENDPOINT }}>
  // 【核心修改 1】定义音乐数据类型接口
  interface MusicData {
    playing: boolean;
    song?: { // song 属性是可选的
      name: string;
      artist: string;
      album: string;
      album_art_url: string;
    };
  }

  const musicContainer = document.getElementById('music-widget-content');
  const refreshIcon = document.getElementById('widget-refresh-icon');

  // 【核心修改 2】为 data 参数指定类型
  function updateMusicWidget(data: MusicData) {
    if (data && data.playing && data.song) {
      musicContainer.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${data.song.album_art_url}" alt="${data.song.album} cover" class="w-10 h-10 rounded-md shadow">
          <div>
            <p class="font-semibold text-base-content truncate" title="${data.song.name}">${data.song.name}</p>
            <p class="text-xs text-base-content/70 truncate" title="${data.song.artist} - ${data.song.album}">${data.song.artist} - ${data.song.album}</p>
          </div>
        </div>
      `;
    } else {
      musicContainer.innerHTML = '<p>当前没有在听歌</p>';
    }
  }

  async function fetchMusicData() {
    try {
      const response = await fetch(API_ENDPOINT);
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      updateMusicWidget(data);
    } catch (error) {
      console.error("Failed to fetch music data:", error);
      musicContainer.innerHTML = '<p class="text-error">获取音乐信息失败</p>';
    } finally {
      if (refreshIcon) {
        refreshIcon.classList.remove('animate-spin');
      }
    }
  }

  document.addEventListener('astro:page-load', fetchMusicData);
  document.addEventListener('refresh-widgets', fetchMusicData);
</script>
